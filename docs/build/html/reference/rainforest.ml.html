

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>rainforest.ml package &mdash; Rainforest QPE library  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Common submodule" href="common.html" />
    <link rel="prev" title="Machine-learning command-line tool" href="ml_cmd.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Rainforest QPE library
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../usage.html#access-library">Access library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage.html#keeping-database-up-to-date">Keeping database up-to-date</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage.html#keeping-randomforest-model-up-to-date">Keeping randomForest model up-to-date</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="interface.html">Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="qpe.html">QPE submodule</a><ul>
<li class="toctree-l3"><a class="reference internal" href="qpe_cmd.html">QPE command-line tools</a><ul>
<li class="toctree-l4"><a class="reference internal" href="qpe_cmd.html#qpe-compute"><em>qpe_compute</em></a></li>
<li class="toctree-l4"><a class="reference internal" href="qpe_cmd.html#qpe-plot"><em>qpe_plot</em></a></li>
<li class="toctree-l4"><a class="reference internal" href="qpe_cmd.html#qpe-evaluation"><em>qpe_evaluation</em></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="rainforest.qpe.html">rainforest.qpe package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="rainforest.qpe.html#module-rainforest.qpe.evaluation">rainforest.qpe.evaluation module</a></li>
<li class="toctree-l4"><a class="reference internal" href="rainforest.qpe.html#module-rainforest.qpe.qpe">rainforest.qpe.qpe module</a></li>
<li class="toctree-l4"><a class="reference internal" href="rainforest.qpe.html#module-rainforest.qpe.qpe_compute">rainforest.qpe.qpe_compute module</a></li>
<li class="toctree-l4"><a class="reference internal" href="rainforest.qpe.html#module-rainforest.qpe.qpe_evaluation">rainforest.qpe.qpe_evaluation module</a></li>
<li class="toctree-l4"><a class="reference internal" href="rainforest.qpe.html#module-rainforest.qpe.qpe_plot">rainforest.qpe.qpe_plot module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="db.html">Database submodule</a><ul>
<li class="toctree-l3"><a class="reference internal" href="db_structure.html">Database structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="db_structure.html#gauge-table"><em>Gauge table</em></a></li>
<li class="toctree-l4"><a class="reference internal" href="db_structure.html#reference-table"><em>Reference table</em></a></li>
<li class="toctree-l4"><a class="reference internal" href="db_structure.html#radar-table"><em>Radar table</em></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="db_options.html">Database configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="db_cmd.html">Database command-line tool</a><ul>
<li class="toctree-l4"><a class="reference internal" href="db_cmd.html#db-populate"><em>db_populate</em></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="rainforest.database.html">rainforest.database package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="rainforest.database.html#module-rainforest.database.database">rainforest.database.database module</a></li>
<li class="toctree-l4"><a class="reference internal" href="rainforest.database.html#module-rainforest.database.db_populate">rainforest.database.db_populate module</a></li>
<li class="toctree-l4"><a class="reference internal" href="rainforest.database.html#module-rainforest.database.retrieve_radar_data">rainforest.database.retrieve_radar_data module</a></li>
<li class="toctree-l4"><a class="reference internal" href="rainforest.database.html#module-rainforest.database.retrieve_reference_data">rainforest.database.retrieve_reference_data module</a></li>
<li class="toctree-l4"><a class="reference internal" href="rainforest.database.html#rainforest-database-retrieve-dwh-data-r-module">rainforest.database.retrieve_dwh_data R module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 current"><a class="reference internal" href="ml.html">ML submodule</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="ml_cmd.html">Machine-learning command-line tool</a><ul>
<li class="toctree-l4"><a class="reference internal" href="ml_cmd.html#rf-train"><em>rf_train</em></a></li>
</ul>
</li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">rainforest.ml package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#module-rainforest.ml.rf">rainforest.ml.rf module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#module-rainforest.ml.rf_train">rainforest.ml.rf_train module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#module-rainforest.ml.rfdefinitions">rainforest.ml.rfdefinitions module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#module-rainforest.ml.utils">rainforest.ml.utils module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="common.html">Common submodule</a><ul>
<li class="toctree-l3"><a class="reference internal" href="common.html#module-rainforest.common.io_data">rainforest.common.io_data module</a></li>
<li class="toctree-l3"><a class="reference internal" href="common.html#module-rainforest.common.retrieve_data">rainforest.common.retrieve_data module</a></li>
<li class="toctree-l3"><a class="reference internal" href="common.html#module-rainforest.common.radarprocessing">rainforest.common.radarprocessing module</a></li>
<li class="toctree-l3"><a class="reference internal" href="common.html#module-rainforest.common.constants">rainforest.common.constants module</a></li>
<li class="toctree-l3"><a class="reference internal" href="common.html#module-rainforest.common.graphics">rainforest.common.graphics module</a></li>
<li class="toctree-l3"><a class="reference internal" href="common.html#module-rainforest.common.lookup">rainforest.common.lookup module</a></li>
<li class="toctree-l3"><a class="reference internal" href="common.html#module-rainforest.common.utils">rainforest.common.utils module</a></li>
<li class="toctree-l3"><a class="reference internal" href="common.html#module-rainforest.common.wgs84_ch1903">rainforest.common.wgs84_ch1903 module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Rainforest QPE library</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Reference</a> &raquo;</li>
        
          <li><a href="ml.html">ML submodule</a> &raquo;</li>
        
      <li>rainforest.ml package</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/reference/rainforest.ml.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="rainforest-ml-package">
<h1>rainforest.ml package<a class="headerlink" href="#rainforest-ml-package" title="Permalink to this headline">¶</a></h1>
<p>This submodule deals with the training and evaluation of machine learning QPE methods. It also allows to read them from pickle files stored in the <em>rf_models</em> subfolder.</p>
<p><a class="reference internal" href="#module-rainforest.ml.rf" title="rainforest.ml.rf"><code class="xref py py-mod docutils literal notranslate"><span class="pre">rainforest.ml.rf</span></code></a> : main module used to train RF regressors</p>
<p><a class="reference internal" href="#module-rainforest.ml.rfdefinitions" title="rainforest.ml.rfdefinitions"><code class="xref py py-mod docutils literal notranslate"><span class="pre">rainforest.ml.rfdefinitions</span></code></a> : reference module that contains definitions of the RF regressors and allows to load them from files</p>
<p><a class="reference internal" href="#module-rainforest.ml.rf_train" title="rainforest.ml.rf_train"><code class="xref py py-mod docutils literal notranslate"><span class="pre">rainforest.ml.rf_train</span></code></a> : command-line utility to train RF models and prepare input features</p>
<p><a class="reference internal" href="#module-rainforest.ml.utils" title="rainforest.ml.utils"><code class="xref py py-mod docutils literal notranslate"><span class="pre">rainforest.ml.utils</span></code></a> : small utilities used in this module only (for example for  vertical aggregation)</p>
<div class="section" id="module-rainforest.ml.rf">
<span id="rainforest-ml-rf-module"></span><h2>rainforest.ml.rf module<a class="headerlink" href="#module-rainforest.ml.rf" title="Permalink to this headline">¶</a></h2>
<p>Main module to</p>
<dl class="class">
<dt id="rainforest.ml.rf.RFTraining">
<em class="property">class </em><code class="sig-prename descclassname">rainforest.ml.rf.</code><code class="sig-name descname">RFTraining</code><span class="sig-paren">(</span><em class="sig-param">db_location</em>, <em class="sig-param">input_location=None</em>, <em class="sig-param">force_regenerate_input=False</em><span class="sig-paren">)</span><a class="headerlink" href="#rainforest.ml.rf.RFTraining" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>This is the main class that allows to preparate data for random forest
training, train random forests and perform cross-validation of trained models</p>
<p>Initializes the class and if needed prepare input data for the training</p>
<p>Note that when calling this constructor the input data is only
generated for the central pixel (NX = NY = 0 = loc of gauge), if you
want to regenerate the inputs for all neighbour pixels, please
call the function self.prepare_input(only_center_pixel = False)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>db_location</strong> (<em>str</em>) – Location of the main directory of the database (with subfolders
‘reference’, ‘gauge’ and ‘radar’ on the filesystem)</p></li>
<li><p><strong>input_location</strong> (<em>str</em>) – Location of the prepared input data, if this data can not be found
in this folder, it will computed here, default is a subfolder
called rf_input_data within db_location</p></li>
<li><p><strong>force_regenerate_input</strong> (<em>bool</em>) – if True the input parquet files will always be regenerated from
the database even if already present in the input_location folder</p></li>
</ul>
</dd>
</dl>
<dl class="method">
<dt id="rainforest.ml.rf.RFTraining.fit_models">
<code class="sig-name descname">fit_models</code><span class="sig-paren">(</span><em class="sig-param">config_file</em>, <em class="sig-param">features_dic</em>, <em class="sig-param">tstart=None</em>, <em class="sig-param">tend=None</em>, <em class="sig-param">output_folder=None</em><span class="sig-paren">)</span><a class="headerlink" href="#rainforest.ml.rf.RFTraining.fit_models" title="Permalink to this definition">¶</a></dt>
<dd><p>Fits a new RF model that can be used to compute QPE realizations and
saves them to disk in pickle format</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>config_file</strong> (<em>str</em>) – Location of the RF training configuration file, if not provided
the default one in the ml submodule will be used</p></li>
<li><p><strong>features_dic</strong> (<em>dict</em>) – A dictionary whose keys are the names of the models you want to
create (a string) and the values are lists of features you want to
use. For example {‘RF_dualpol’:[‘RADAR’, ‘zh_VISIB_mean’,
‘zv_VISIB_mean’,’KDP_mean’,’RHOHV_mean’,’T’, ‘HEIGHT’,’VISIB_mean’]}
will train a model with all these features that will then be stored
under the name RF_dualpol_BC_&lt;type of BC&gt;.p in the ml/rf_models dir</p></li>
<li><p><strong>tstart</strong> (<em>datetime</em>) – the starting time of the training time interval, default is to start
at the beginning of the time interval covered by the database</p></li>
<li><p><strong>tend</strong> (<em>datetime</em>) – the end time of the training time interval, default is to end
at the end of the time interval covered by the database</p></li>
<li><p><strong>output_folder</strong> (<em>str</em>) – Location where to store the trained models in pickle format,
if not provided it will store them in the standard location
&lt;library_path&gt;/ml/rf_models</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="rainforest.ml.rf.RFTraining.model_intercomparison">
<code class="sig-name descname">model_intercomparison</code><span class="sig-paren">(</span><em class="sig-param">features_dic, intercomparison_configfile, output_folder, reference_products=['CPC', 'RZC'], bounds10=[0, 2, 10, 100], bounds60=[0, 1, 10, 100], K=5</em><span class="sig-paren">)</span><a class="headerlink" href="#rainforest.ml.rf.RFTraining.model_intercomparison" title="Permalink to this definition">¶</a></dt>
<dd><p>Does an intercomparison (cross-validation) of different RF models and
reference products (RZC, CPC, …) and plots the performance plots</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>features_dic</strong> (<em>dict</em>) – A dictionary whose keys are the names of the models you want to
compare (a string) and the values are lists of features you want to
use. For example {‘RF_dualpol’:[‘RADAR’, ‘zh_VISIB_mean’,
‘zv_VISIB_mean’,’KDP_mean’,’RHOHV_mean’,’T’, ‘HEIGHT’,’VISIB_mean’],
‘RF_hpol’:[‘RADAR’, ‘zh_VISIB_mean’,’T’, ‘HEIGHT’,’VISIB_mean’]}
will compare a model of RF with polarimetric info to a model
with only horizontal polarization</p></li>
<li><p><strong>output_folder</strong> (<em>str</em>) – Location where to store the output plots</p></li>
<li><p><strong>intercomparison_config</strong> (<em>str</em>) – Location of the intercomparison configuration file, which
is a yaml file that gives for every model key of features_dic which
parameters of the training you want to use (see the file
intercomparison_config_example.yml in this module for an example)</p></li>
<li><p><strong>reference_products</strong> (<em>list of str</em>) – Name of the reference products to which the RF will be compared
they need to be in the reference table of the database</p></li>
<li><p><strong>bounds10</strong> (<em>list of float</em>) – list of precipitation bounds for which to compute scores separately
at 10 min time resolution
[0,2,10,100] will give scores in range [0-2], [2-10] and [10-100]</p></li>
<li><p><strong>bounds60</strong> (<em>list of float</em>) – list of precipitation bounds for which to compute scores separately
at hourly time resolution
[0,1,10,100] will give scores in range [0-1], [1-10] and [10-100]</p></li>
<li><p><strong>K</strong> (<em>int</em>) – Number of splits in iterations do perform in the K fold cross-val</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="rainforest.ml.rf.RFTraining.prepare_input">
<code class="sig-name descname">prepare_input</code><span class="sig-paren">(</span><em class="sig-param">only_center=True</em><span class="sig-paren">)</span><a class="headerlink" href="#rainforest.ml.rf.RFTraining.prepare_input" title="Permalink to this definition">¶</a></dt>
<dd><p>Reads the data from the database  in db_location and processes it to
create easy to use parquet input files for the ML training and stores
them in the input_location, the processing steps involve</p>
<p>For every neighbour of the station (i.e. from -1-1 to +1+1):</p>
<ul class="simple">
<li><p>Replace missing flags by nans</p></li>
<li><p>Filter out timesteps which are not present in the three tables
(gauge, reference and radar)</p></li>
<li><p>Filter out incomplete hours (i.e. where less than 6 10 min timesteps
are available)</p></li>
<li><p>Add height above ground and height of iso0 to radar data</p></li>
<li><p>Save a separate parquet file for radar, gauge and reference data</p></li>
<li><p>Save a grouping_idx pickle file containing <em>grp_vertical</em>
index (groups all radar rows with same timestep and station),
<em>grp_hourly</em> (groups all timesteps with same hours) and <em>tstamp_unique</em>
(list of all unique timestamps)</p></li>
</ul>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>only_center</strong> (<em>bool</em>) – If set to True only the input data for the central neighbour
i.e. NX = NY = 0 (the location of the gauge) will be recomputed
this takes much less time and is the default option since until
now the neighbour values are not used in the training of the RF
QPE</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-rainforest.ml.rf_train">
<span id="rainforest-ml-rf-train-module"></span><h2>rainforest.ml.rf_train module<a class="headerlink" href="#module-rainforest.ml.rf_train" title="Permalink to this headline">¶</a></h2>
<p>Command line script to prepare input features and train RF models</p>
<p>see <a class="reference internal" href="ml_cmd.html#rf-train"><span class="std std-ref">rf_train</span></a></p>
<dl class="function">
<dt id="rainforest.ml.rf_train.main">
<code class="sig-prename descclassname">rainforest.ml.rf_train.</code><code class="sig-name descname">main</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#rainforest.ml.rf_train.main" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
<div class="section" id="module-rainforest.ml.rfdefinitions">
<span id="rainforest-ml-rfdefinitions-module"></span><h2>rainforest.ml.rfdefinitions module<a class="headerlink" href="#module-rainforest.ml.rfdefinitions" title="Permalink to this headline">¶</a></h2>
<p>Class declarations and reading functions
required to unpickle trained RandomForest models</p>
<p>Daniel Wolfensberger
MeteoSwiss/EPFL
<a class="reference external" href="mailto:daniel&#46;wolfensberger&#37;&#52;&#48;epfl&#46;ch">daniel<span>&#46;</span>wolfensberger<span>&#64;</span>epfl<span>&#46;</span>ch</a>
December 2019</p>
<dl class="class">
<dt id="rainforest.ml.rfdefinitions.MyCustomUnpickler">
<em class="property">class </em><code class="sig-prename descclassname">rainforest.ml.rfdefinitions.</code><code class="sig-name descname">MyCustomUnpickler</code><a class="headerlink" href="#rainforest.ml.rfdefinitions.MyCustomUnpickler" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">_pickle.Unpickler</span></code></p>
<p>This is an extension of the pickle Unpickler that handles the
bookeeeping references to the RandomForestRegressorBC class</p>
<dl class="method">
<dt id="rainforest.ml.rfdefinitions.MyCustomUnpickler.find_class">
<code class="sig-name descname">find_class</code><span class="sig-paren">(</span><em class="sig-param">module</em>, <em class="sig-param">name</em><span class="sig-paren">)</span><a class="headerlink" href="#rainforest.ml.rfdefinitions.MyCustomUnpickler.find_class" title="Permalink to this definition">¶</a></dt>
<dd><p>Return an object from a specified module.</p>
<p>If necessary, the module will be imported. Subclasses may override
this method (e.g. to restrict unpickling of arbitrary classes and
functions).</p>
<p>This method is called whenever a class or a function object is
needed.  Both arguments passed are str objects.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="rainforest.ml.rfdefinitions.RandomForestRegressorBC">
<em class="property">class </em><code class="sig-prename descclassname">rainforest.ml.rfdefinitions.</code><code class="sig-name descname">RandomForestRegressorBC</code><span class="sig-paren">(</span><em class="sig-param">variables</em>, <em class="sig-param">beta</em>, <em class="sig-param">degree=1</em>, <em class="sig-param">bctype='cdf'</em>, <em class="sig-param">n_estimators=100</em>, <em class="sig-param">criterion='mse'</em>, <em class="sig-param">max_depth=None</em>, <em class="sig-param">min_samples_split=2</em>, <em class="sig-param">min_samples_leaf=1</em>, <em class="sig-param">min_weight_fraction_leaf=0.0</em>, <em class="sig-param">max_features='auto'</em>, <em class="sig-param">max_leaf_nodes=None</em>, <em class="sig-param">min_impurity_decrease=0.0</em>, <em class="sig-param">min_impurity_split=None</em>, <em class="sig-param">bootstrap=True</em>, <em class="sig-param">oob_score=False</em>, <em class="sig-param">n_jobs=None</em>, <em class="sig-param">random_state=None</em>, <em class="sig-param">verbose=0</em>, <em class="sig-param">warm_start=False</em><span class="sig-paren">)</span><a class="headerlink" href="#rainforest.ml.rfdefinitions.RandomForestRegressorBC" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">sklearn.ensemble.forest.RandomForestRegressor</span></code></p>
<p>This is an extension of the RandomForestRegressor regressor class of
sklearn that does additional bias correction, is able
to apply a rounding function to the outputs on the fly and adds a
bit of metadata:</p>
<blockquote>
<div><p><em>bctype</em> : type of bias correction method
<em>variables</em> : name of input features
<em>beta</em> : weighting factor in vertical aggregation
<em>degree</em> : order of the polyfit used in some bias-correction methods</p>
</div></blockquote>
<p>For <em>bc_type</em> tHe available methods are currently “raw”:
simple linear fit between prediction and observation, “cdf”: linear fit
between sorted predictions and sorted observations and “spline” :
spline fit between sorted predictions and sorted observations. Any
new method should be added in this class in order to be used.</p>
<p>For any information regarding the sklearn parent class see</p>
<p><a class="reference external" href="https://github.com/scikit-learn/scikit-learn/blob/b194674c4/sklearn/ensemble/_forest.py#L1150">https://github.com/scikit-learn/scikit-learn/blob/b194674c4/sklearn/ensemble/_forest.py#L1150</a></p>
<dl class="method">
<dt id="rainforest.ml.rfdefinitions.RandomForestRegressorBC.fit">
<code class="sig-name descname">fit</code><span class="sig-paren">(</span><em class="sig-param">X</em>, <em class="sig-param">y</em>, <em class="sig-param">sample_weight=None</em><span class="sig-paren">)</span><a class="headerlink" href="#rainforest.ml.rfdefinitions.RandomForestRegressorBC.fit" title="Permalink to this definition">¶</a></dt>
<dd><p>Fit both estimator and a-posteriori bias correction
:param X: The input samples. Use <code class="docutils literal notranslate"><span class="pre">dtype=np.float32</span></code> for maximum</p>
<blockquote>
<div><p>efficiency. Sparse matrices are also supported, use sparse
<code class="docutils literal notranslate"><span class="pre">csc_matrix</span></code> for maximum efficiency.</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>sample_weight</strong> (<em>array-like of shape</em><em> (</em><em>n_samples</em><em>,</em><em>)</em><em>, </em><em>default=None</em>) – Sample weights. If None, then samples are equally weighted. Splits
that would create child nodes with net zero or negative weight are
ignored while searching for a split in each node. In the case of
classification, splits are also ignored if they would result in any
single class carrying a negative weight in either child node.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><strong>self</strong></p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>object</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="rainforest.ml.rfdefinitions.RandomForestRegressorBC.predict">
<code class="sig-name descname">predict</code><span class="sig-paren">(</span><em class="sig-param">X</em>, <em class="sig-param">round_func=None</em>, <em class="sig-param">bc=True</em><span class="sig-paren">)</span><a class="headerlink" href="#rainforest.ml.rfdefinitions.RandomForestRegressorBC.predict" title="Permalink to this definition">¶</a></dt>
<dd><p>Predict regression target for X.
The predicted regression target of an input sample is computed as the
mean predicted regression targets of the trees in the forest.
:param X: The input samples. Internally, its dtype will be converted to</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">dtype=np.float32</span></code>. If a sparse matrix is provided, it will be
converted into a sparse <code class="docutils literal notranslate"><span class="pre">csr_matrix</span></code>.</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>round_func</strong> (<em>lambda function</em>) – Optional function to apply to outputs (for example to discretize them
using MCH lookup tables). If not provided f(x) = x will be applied
(i.e. no function)</p></li>
<li><p><strong>bc</strong> (<em>bool</em>) – if True the bias correction function will be applied</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><strong>y</strong> – The predicted values.</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>array-like of shape (n_samples,) or (n_samples, n_outputs)</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="rainforest.ml.rfdefinitions.read_rf">
<code class="sig-prename descclassname">rainforest.ml.rfdefinitions.</code><code class="sig-name descname">read_rf</code><span class="sig-paren">(</span><em class="sig-param">rf_name</em><span class="sig-paren">)</span><a class="headerlink" href="#rainforest.ml.rfdefinitions.read_rf" title="Permalink to this definition">¶</a></dt>
<dd><p>Reads a randomForest model from the RF models folder using pickle. All custom
classes and functions used in the construction of these pickled models
must be defined in the script ml/rf_definitions.py</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>rf_name</strong> (<em>str</em>) – Name of the randomForest model, it must be stored in the folder
/ml/rf_models and computed with the rf:RFTraining.fit_model function</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><em>A trained sklearn randomForest instance that has the predict() method,</em></p></li>
<li><p><em>that allows to predict precipitation intensities for new points</em></p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-rainforest.ml.utils">
<span id="rainforest-ml-utils-module"></span><h2>rainforest.ml.utils module<a class="headerlink" href="#module-rainforest.ml.utils" title="Permalink to this headline">¶</a></h2>
<p>Utility functions for the ML submodule</p>
<dl class="function">
<dt id="rainforest.ml.utils.nesteddictvalues">
<code class="sig-prename descclassname">rainforest.ml.utils.</code><code class="sig-name descname">nesteddictvalues</code><span class="sig-paren">(</span><em class="sig-param">d</em><span class="sig-paren">)</span><a class="headerlink" href="#rainforest.ml.utils.nesteddictvalues" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="rainforest.ml.utils.split_event">
<code class="sig-prename descclassname">rainforest.ml.utils.</code><code class="sig-name descname">split_event</code><span class="sig-paren">(</span><em class="sig-param">timestamps</em>, <em class="sig-param">n=5</em>, <em class="sig-param">threshold_hr=12</em><span class="sig-paren">)</span><a class="headerlink" href="#rainforest.ml.utils.split_event" title="Permalink to this definition">¶</a></dt>
<dd><p>Splits the dataset into n subsets by separating the observations into
separate precipitation events and attributing these events randomly
to the subsets</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>timestamps</strong> (<em>int array</em>) – array containing the UNIX timestamps of the precipitation observations</p></li>
<li><p><strong>n</strong> (<em>int</em>) – number of subsets to create</p></li>
<li><p><strong>threshold_hr</strong> (<em>int</em>) – threshold in hours to distinguish precip events. Two timestamps are
considered to belong to a different event if there is a least
threshold_hr hours of no observations (no rain) between them.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><strong>split_idx</strong> – array containing the subset grouping, with values from 0 to n - 1</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>int array</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="rainforest.ml.utils.vert_aggregation">
<code class="sig-prename descclassname">rainforest.ml.utils.</code><code class="sig-name descname">vert_aggregation</code><span class="sig-paren">(</span><em class="sig-param">radar_data</em>, <em class="sig-param">vert_weights</em>, <em class="sig-param">grp_vertical</em>, <em class="sig-param">visib_weight=True</em>, <em class="sig-param">visib=None</em><span class="sig-paren">)</span><a class="headerlink" href="#rainforest.ml.utils.vert_aggregation" title="Permalink to this definition">¶</a></dt>
<dd><p>Performs vertical aggregation of radar observations aloft to the ground
using a weighted average. Categorical variables such as ‘RADAR’,
‘HYDRO’, ‘TCOUNT’, will be assigned dummy variables and these dummy
variables will be aggregated, resulting in columns such as RADAR_propA
giving the weighted proportion of radar observation aloft that were
obtained with the Albis radar</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>radar_data</strong> (<em>Pandas DataFrame</em>) – A Pandas DataFrame containing all required input features aloft as
explained in the rf.py module</p></li>
<li><p><strong>vert_weights</strong> (<em>np.array of float</em>) – vertical weights to use for every observation in radar, must have
the same len as radar_data</p></li>
<li><p><strong>grp_vertical</strong> (<em>np.array of int</em>) – grouping index for the vertical aggregation. It must have the same
len as radar_data. All observations corresponding to the same
timestep must have the same label</p></li>
<li><p><strong>visib_weight</strong> (<em>bool</em>) – if True the input features will be weighted by the visibility
when doing the vertical aggregation to the ground</p></li>
<li><p><strong>visib</strong> (<em>np array</em>) – visibily of every observation, required only if visib_weight = True</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="common.html" class="btn btn-neutral float-right" title="Common submodule" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="ml_cmd.html" class="btn btn-neutral float-left" title="Machine-learning command-line tool" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Daniel Wolfensherger

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>